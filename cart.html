<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carrito</title>
<style>
body { font-family: Arial, sans-serif; background-color: #f7f5f0; color:#333; margin:0; padding:0; }
header { background-color:#d1c4b2; padding:20px; text-align:center; }
h1 { margin:0; }
.container { padding:20px; max-width:800px; margin:auto; }
table { width:100%; border-collapse: collapse; margin-bottom:20px; }
th, td { padding:10px; border-bottom:1px solid #ccc; text-align:center; }
button { padding:8px 12px; border:none; background-color:#8d6e63; color:white; cursor:pointer; border-radius:5px; }
input[type="text"], input[type="tel"] { padding:8px; width:100%; margin-bottom:10px; border-radius:5px; border:1px solid #ccc; }
</style>
</head>
<body>
<header>
  <h1>Carrito de Compras</h1>
</header>

<div class="container">
  <table id="cartTable">
    <thead>
      <tr><th>Perfume</th><th>Tamaño</th><th>Precio</th><th>Cantidad</th><th>Total</th><th>Eliminar</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <p>Total: <span id="grandTotal">0</span> COP</p>

  <h2>Datos de entrega</h2>
  <input type="text" id="name" placeholder="Nombre completo">
  <input type="tel" id="phone" placeholder="Número de contacto">
  <input type="text" id="address" placeholder="Dirección de entrega">
  <label>Método de pago:</label>
  <select id="payment">
    <option value="nequi">Nequi</option>
    <option value="tranfiya">Tranfiya</option>
    <option value="efectivo">Efectivo</option>
  </select>

  <button onclick="checkout()">Finalizar Compra</button>
</div>

<script>
function loadCart(){
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const tbody = document.querySelector("#cartTable tbody");
  tbody.innerHTML="";
  let grandTotal =0;
  cart.forEach((p,i)=>{
    const sizes=["30 ml","50 ml","110 ml"];
    const row = document.createElement("tr");
    const total=p.qty*p.price;
    grandTotal += total;
    row.innerHTML = `
      <td>${p.display}</td>
      <td>${sizes[p.size]}</td>
      <td>${p.price}</td>
      <td>${p.qty} <button onclick="changeQty(${i},1)">+</button><button onclick="changeQty(${i},-1)">-</button></td>
      <td>${total}</td>
      <td><button onclick="removeItem(${i})">Eliminar</button></td>
    `;
    tbody.appendChild(row);
  });
  document.getElementById("grandTotal").innerText = grandTotal;
}

function changeQty(index, delta){
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  cart[index].qty += delta;
  if(cart[index].qty<1) cart[index].qty=1;
  localStorage.setItem("cart", JSON.stringify(cart));
  loadCart();
}

function removeItem(index){
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  cart.splice(index,1);
  localStorage.setItem("cart", JSON.stringify(cart));
  loadCart();
}

function checkout(){
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  if(cart.length===0){ alert("Carrito vacío"); return; }
  const name = document.getElementById("name").value;
  const phone = document.getElementById("phone").value;
  const address = document.getElementById("address").value;
  const payment = document.getElementById("payment").value;
  if(!name || !phone || !address){ alert("Completa todos los datos"); return; }

  let message="Nuevo pedido:\n\n";
  cart.forEach(p=>{
    const sizes=["30 ml","50 ml","110 ml"];
    message += `${p.display} - ${sizes[p.size]} x${p.qty} = ${p.price*p.qty} COP\n`;
  });
  message += `Total: ${cart.reduce((sum,p)=>sum+p.price*p.qty,0)} COP\n`;
  message += `Nombre: ${name}\nTeléfono: ${phone}\nDirección: ${address}\nMétodo de pago: ${payment}`;

  // Email via EmailJS
  emailjs.send('service_4zsh227','template_9pw5f7b',{
    message: message
  }).then(function(){
    alert("Pedido enviado correctamente");
    localStorage.removeItem("cart");
    window.location.href="index.html";
  },function(err){
    alert("Error al enviar pedido, intenta de nuevo");
    console.error(err);
  });
}

loadCart();
</script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  emailjs.init("template_9pw5f7b");
</script>
</body>
</html>
